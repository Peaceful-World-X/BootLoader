# BootLoader - åµŒå…¥å¼å›ºä»¶å‡çº§å·¥å…·

[![Qt Version](https://img.shields.io/badge/Qt-6.8.1-green.svg)](https://www.qt.io/)
[![C++](https://img.shields.io/badge/C++-17-blue.svg)](https://isocpp.org/)
[![Platform](https://img.shields.io/badge/platform-Windows-lightgrey.svg)](https://www.microsoft.com/windows)
[![License](https://img.shields.io/badge/license-MIT-green.svg)](LICENSE)

> åŸºäºŽ Qt 6.8.1 å¼€å‘çš„åµŒå…¥å¼å›ºä»¶å‡çº§å·¥å…·ï¼Œæ”¯æŒä¸²å£/ç½‘å£åŒæ¨¡å¼ï¼Œå¯å¯¹ FPGAã€DSPã€ARM ç­‰å¤šç§è®¾å¤‡è¿›è¡Œå›ºä»¶å‡çº§ã€‚

## âœ¨ ç‰¹æ€§

- ðŸ”Œ **åŒé€šä¿¡æ¨¡å¼** - æ”¯æŒä¸²å£ï¼ˆRS232/USB-TTLï¼‰å’Œç½‘å£ï¼ˆTCPï¼‰
- ðŸŽ¯ **å¤šè®¾å¤‡æ”¯æŒ** - FPGAã€DSP1ã€DSP2ã€ARM å››ç§è®¾å¤‡ç±»åž‹
- ðŸ“¦ **å®žæ—¶è¿›åº¦** - æ˜¾ç¤ºå‡çº§è¿›åº¦å’Œè¯¦ç»†çŠ¶æ€ä¿¡æ¯
- ðŸ“ **æ—¥å¿—è®°å½•** - å®Œæ•´çš„é€šä¿¡æ—¥å¿—ï¼Œä¾¿äºŽè°ƒè¯•å’Œé—®é¢˜æŽ’æŸ¥
- ðŸ”„ **æ™ºèƒ½é‡è¯•** - è‡ªåŠ¨è¶…æ—¶æ£€æµ‹å’Œé‡ä¼ æœºåˆ¶

---

## é¡¹ç›®ç»“æž„

```
BootLoader/
â”œâ”€â”€ bin/                              # å¯æ‰§è¡Œæ–‡ä»¶ç›®å½•
â”‚   â”œâ”€â”€ BootLoader.exe                # ç¼–è¯‘åŽçš„å¯æ‰§è¡Œç¨‹åº
â”‚   â”œâ”€â”€ BootLoader ä½¿ç”¨è¯´æ˜Ž.md         # è½¯ä»¶ä½¿ç”¨æ‰‹å†Œ
â”‚   â””â”€â”€ bootloader.log                # è¿è¡Œæ—¥å¿—æ–‡ä»¶ï¼ˆè‡ªåŠ¨ç”Ÿæˆï¼‰
â”‚
â”œâ”€â”€ doc/                              # æ–‡æ¡£ç›®å½•
â”‚   â””â”€â”€ BootLoaderæµç¨‹åè®®è§£æž.md      # é€šä¿¡åè®®è¯¦ç»†è¯´æ˜Ž
â”‚
â”œâ”€â”€ gui/                              # ç•Œé¢è®¾è®¡æ–‡ä»¶
â”‚   â””â”€â”€ mainwindow.ui                 # Qt Designer UI æ–‡ä»¶
â”‚
â”œâ”€â”€ inc/                              # å¤´æ–‡ä»¶ç›®å½•
â”‚   â”œâ”€â”€ communication.h               # é€šä¿¡ç®¡ç†å™¨ç±»
â”‚   â”œâ”€â”€ mainwindow.h                  # ä¸»çª—å£ç±»
â”‚   â”œâ”€â”€ protocol.h                    # åè®®è§£æžç±»
â”‚   â””â”€â”€ upgrade.h                     # å‡çº§ç®¡ç†å™¨ç±»
â”‚
â”œâ”€â”€ src/                              # æºæ–‡ä»¶ç›®å½•
â”‚   â”œâ”€â”€ communication.cpp             # ä¸²å£/TCP é€šä¿¡å®žçŽ°
â”‚   â”œâ”€â”€ main.cpp                      # ç¨‹åºå…¥å£ï¼ˆå«è¯•ç”¨æœŸéªŒè¯ï¼‰
â”‚   â”œâ”€â”€ mainwindow.cpp                # ä¸»çª—å£å®žçŽ°
â”‚   â”œâ”€â”€ protocol.cpp                  # åè®®ç¼–ç /è§£ç å®žçŽ°
â”‚   â””â”€â”€ upgrade.cpp                   # å‡çº§çŠ¶æ€æœºå®žçŽ°
â”‚
â”œâ”€â”€ test/                             # æµ‹è¯•å·¥å…·ç›®å½•
â”‚   â”œâ”€â”€ test_TCP.py                   # TCP ç½‘å£æµ‹è¯•æœåŠ¡å™¨ï¼ˆæ¨¡æ‹Ÿä¸‹ä½æœºï¼‰
â”‚   â””â”€â”€ test_COM.py                   # ä¸²å£æµ‹è¯•æœåŠ¡å™¨ï¼ˆæ¨¡æ‹Ÿä¸‹ä½æœºï¼‰
â”‚
â”œâ”€â”€ BootLoader.pro                    # Qt é¡¹ç›®æ–‡ä»¶
â”œâ”€â”€ README.md                         # é¡¹ç›®è¯´æ˜Žæ–‡æ¡£ï¼ˆæœ¬æ–‡ä»¶ï¼‰
â””â”€â”€ .gitignore                        # Git å¿½ç•¥é…ç½®

```

---

## æ ¸å¿ƒæ¨¡å—è¯´æ˜Ž

### 1. é€šä¿¡æ¨¡å— (`communication.cpp/h`)
è´Ÿè´£åº•å±‚ä¸²å£å’Œ TCP é€šä¿¡

### 2. åè®®æ¨¡å— (`protocol.cpp/h`)
å®žçŽ° BootLoader åè®®çš„ç¼–ç å’Œè§£æž

### 3. å‡çº§ç®¡ç†æ¨¡å— (`upgrade.cpp/h`)
ç®¡ç†æ•´ä¸ªå‡çº§æµç¨‹çŠ¶æ€æœº

### 4. ä¸»çª—å£æ¨¡å— (`mainwindow.cpp/h`)
æä¾›ç”¨æˆ·äº¤äº’ç•Œé¢

---

## ç¼–è¯‘å’Œæž„å»º

### å¼€å‘çŽ¯å¢ƒè¦æ±‚
- **Qt ç‰ˆæœ¬**ï¼š6.8.1 æˆ–æ›´é«˜
- **ç¼–è¯‘å™¨**ï¼šMinGW 64-bitï¼ˆWindowsï¼‰
- **IDE**ï¼šQt Creator 13.0+ æˆ– Visual Studio 2019+
- **CMake**ï¼š3.16+ ï¼ˆå¯é€‰ï¼‰

---

## æµ‹è¯•æ–¹æ³•

é¡¹ç›®æä¾›äº†ä¸¤ä¸ª Python æµ‹è¯•è„šæœ¬ï¼Œç”¨äºŽæ¨¡æ‹Ÿä¸‹ä½æœºå“åº”ï¼Œä¾¿äºŽåœ¨æ²¡æœ‰å®žé™…ç¡¬ä»¶æ—¶è¿›è¡ŒåŠŸèƒ½æµ‹è¯•ã€‚

### æµ‹è¯•å·¥å…·è¯´æ˜Ž

#### 1. TCP ç½‘å£æµ‹è¯• (`test_TCP.py`)
æ¨¡æ‹Ÿé€šè¿‡ TCP ç½‘ç»œè¿žæŽ¥çš„ä¸‹ä½æœºã€‚

#### 2. ä¸²å£æµ‹è¯• (`test_COM.py`)
æ¨¡æ‹Ÿé€šè¿‡ä¸²å£è¿žæŽ¥çš„ä¸‹ä½æœºã€‚

---

## åè®®è¯´æ˜Ž

è¯¦ç»†çš„é€šä¿¡åè®®è¯·å‚è€ƒï¼š[doc/BootLoaderæµç¨‹åè®®è§£æž.md](doc/BootLoaderæµç¨‹åè®®è§£æž.md)

### åè®®è¦ç‚¹
- **å¸§å¤´**ï¼šä¸Šä½æœº `0xAA 0x55`ï¼Œä¸‹ä½æœº `0x55 0xAA`
- **é•¿åº¦**ï¼šå¤§ç«¯åº 2 å­—èŠ‚ï¼Œè¡¨ç¤ºæ•´å¸§é•¿åº¦
- **æŠ¥æ–‡ç±»åž‹**ï¼šåŒºåˆ†è¯·æ±‚ã€æ•°æ®ã€ç»“æŸç­‰ä¸åŒé˜¶æ®µ
- **åº”ç­”æ ‡è¯†**ï¼šä¸Šä½æœºå›ºå®š `0xFE`ï¼Œä¸‹ä½æœºè¡¨ç¤ºæ‰§è¡ŒçŠ¶æ€
- **CRC**ï¼šCRC16-MODBUSï¼Œé«˜ä½åœ¨å‰

### å‡çº§æµç¨‹
```
ä¸Šä½æœº                                     ä¸‹ä½æœº
  |                                          |
  |--- 0x01 å‡çº§è¯·æ±‚ ----------------------->|
  |<-- 0x01 å…è®¸å‡çº§ (FLAG=0x04) ------------|
  |                                          |
  |--- 0x02 ç³»ç»Ÿå¤ä½ ----------------------->|
  |<-- 0x02 é‡å¯æˆåŠŸ (FLAG=0x0C) ------------|
  |                                          |
  |--- 0x06 FPGAå‡çº§æŒ‡ä»¤ -------------------->|
  |<-- 0x06 æ“¦é™¤FlashæˆåŠŸ (FLAG=0x0A) --------|
  |                                          |
  |--- 0x07 FPGAæ•°æ®åŒ… 1 -------------------->|
  |<-- 0x07 å‘½ä»¤æ‰§è¡ŒæˆåŠŸ (FLAG=0x00) ---------|
  |--- 0x07 FPGAæ•°æ®åŒ… 2 -------------------->|
  |<-- 0x07 å‘½ä»¤æ‰§è¡ŒæˆåŠŸ ---------------------|
  |    ... (å¾ªçŽ¯å‘é€æ‰€æœ‰æ•°æ®åŒ…)                |
  |                                          |
  |--- 0x09 FPGAå‡çº§ç»“æŸ -------------------->|
  |<-- 0x09 æ‰€æœ‰æ•°æ®åŒ…å‘é€æˆåŠŸ (FLAG=0x0E) ---|
  |                                          |
  |    ... (DSP1, DSP2, ARM åŒæ ·æµç¨‹)         |
  |                                          |
  |--- 0x10 æ€»ä½“ç»“æŸ ------------------------>|
  |<-- 0x10 å‘½ä»¤æ‰§è¡ŒæˆåŠŸ (FLAG=0x00) ---------|
  |                                          |
```

---

## æ•…éšœæŽ’æŸ¥

### å¸¸è§é—®é¢˜

| é—®é¢˜ | å¯èƒ½åŽŸå›  | è§£å†³æ–¹æ³• |
|------|---------|---------|
| ä¸²å£æ‰“å¼€å¤±è´¥ | ç«¯å£è¢«å ç”¨ | å…³é—­å…¶ä»–ä¸²å£å·¥å…·ï¼Œé‡æ–°æ’æ‹”è®¾å¤‡ |
| TCP è¿žæŽ¥è¶…æ—¶ | IP æˆ–ç«¯å£é”™è¯¯ | æ£€æŸ¥ IP é…ç½®ï¼Œä½¿ç”¨ `ping` æµ‹è¯• |
| CRC æ ¡éªŒå¤±è´¥ | é€šä¿¡å¹²æ‰°æˆ–æ•°æ®æŸå | é™ä½Žæ³¢ç‰¹çŽ‡ï¼Œå‡å°æ•°æ®åŒ…å¤§å° |
| å‡çº§è¶…æ—¶ | è®¾å¤‡å“åº”æ…¢æˆ–æœªå“åº” | æ£€æŸ¥è®¾å¤‡çŠ¶æ€ï¼Œé‡å¯è®¾å¤‡ |

### è°ƒè¯•å»ºè®®
1. **å¯ç”¨æ—¥å¿—**ï¼šå‹¾é€‰æ—¥å¿—åŠŸèƒ½ï¼Œä¾¿äºŽäº‹åŽåˆ†æž
2. **é™ä½Žé€Ÿåº¦**ï¼šå‡å°æ•°æ®åŒ…å¤§å°ï¼ˆå¦‚ 512ï¼‰ï¼Œé™ä½Žä¼ è¾“é€ŸçŽ‡
3. **éš”ç¦»æµ‹è¯•**ï¼šå…ˆç”¨æµ‹è¯•è„šæœ¬éªŒè¯é€šä¿¡ï¼Œå†æµ‹è¯•çœŸå®žè®¾å¤‡
4. **æ£€æŸ¥ç¡¬ä»¶**ï¼šç¡®è®¤çº¿ç¼†è´¨é‡ã€æŽ¥å£ç‰¢å›ºã€ä¾›ç”µç¨³å®š

---

## å¼€å‘æŒ‡å—

### æ·»åŠ æ–°è®¾å¤‡ç±»åž‹
1. åœ¨ `protocol.h` ä¸­æ·»åŠ æ–°çš„æŠ¥æ–‡ç±»åž‹å¸¸é‡
2. åœ¨ `upgrade.cpp` ä¸­çš„è®¾å¤‡åˆ—è¡¨æ·»åŠ æ–°è®¾å¤‡
3. åœ¨ `mainwindow.ui` ä¸­æ·»åŠ å¯¹åº”çš„å¤é€‰æ¡†å’Œæ–‡ä»¶é€‰æ‹©æŽ§ä»¶
4. æ›´æ–°çŠ¶æ€æœºé€»è¾‘ï¼Œæ·»åŠ æ–°è®¾å¤‡çš„å‡çº§æµç¨‹

### ä¿®æ”¹é€šä¿¡å‚æ•°
- **ä¸²å£æ³¢ç‰¹çŽ‡**ï¼šä¿®æ”¹ `communication.cpp` ä¸­çš„ `openSerial()` å‡½æ•°
- **TCP ç«¯å£**ï¼šä¿®æ”¹ç•Œé¢é»˜è®¤å€¼å’Œ `openTcp()` å‡½æ•°
- **è¶…æ—¶æ—¶é—´**ï¼šä¿®æ”¹ `upgrade.cpp` ä¸­çš„è¶…æ—¶å®šæ—¶å™¨æ—¶é•¿

### æ‰©å±•åè®®
å¦‚éœ€æ”¯æŒæ–°çš„åº”ç­”æ ‡è¯†æˆ–æŠ¥æ–‡ç±»åž‹ï¼Œéœ€åŒæ­¥ä¿®æ”¹ï¼š
1. `protocol.h` - æ·»åŠ å¸¸é‡å®šä¹‰
2. `protocol.cpp` - æ›´æ–°æè¿°æ˜ å°„å‡½æ•°
3. `upgrade.cpp` - æ›´æ–°çŠ¶æ€æœºå¤„ç†é€»è¾‘

---
