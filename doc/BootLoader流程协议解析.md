# BootLoader协议解析

## 概述

**上位机**: 基于QT开发"嵌入式通用下载工具"

**下位机**: 嵌入式目标板(ARM DSP FPGA)

**串口协议**: 基于USB转TTL工具/网口

升级协议整体如下表所示。

## 上位机发送报文结构

| 字节序号 | 数据名称 | 字节数 | 数据类型 | 数据内容 |
|---------|---------|-------|---------|---------|
| 0 | 报头 | 1 | Uint8 | 固定为0xAA |
| 1 | 报头 | 1 | Uint8 | 固定为0x55 |
| 2 | 下位机ID | 1 | Uint8 | 串口模式根据界面下串口模式ID获取,网口模式默认填充IP最后字节<br>例如:从机IP:192.168.100.70 则填充70 |
| 3 | 报文长度高位 | 1 | Uint8 | 报文总字节长度 |
| 4 | 报文长度低位 | 1 | Uint8 | |
| 5 | 报文类型 | 1 | Uint8 | **功能码及含义:**<br>0x01 - 升级请求报文 (系统控制)<br>0x02 - 系统复位命令报文 (系统命令)<br>0x03 - 升级ARM命令报文 (ARM)<br>0x04 - 升级ARM数据报文 (ARM)<br>0x05 - 升级ARM结束报文 (ARM)<br>0x06 - 升级FPGA命令报文 (FPGA)<br>0x07 - 升级FPGA数据报文 (FPGA)<br>0x09 - 升级FPGA结束报文 (FPGA)<br>0x0A - 升级DSP1命令报文 (DSP)<br>0x0B - 升级DSP1数据报文 (DSP)<br>0x0C - 升级DSP1结束报文 (DSP)<br>0x0D - 升级DSP2命令报文 (DSP)<br>0x0E - 升级DSP2数据报文 (DSP)<br>0x0F - 升级DSP2结束报文 (DSP)<br>0x10 - 总体结束 (系统命令) |
| 6 | 应答标识 | 1 | Uint8 | 0xFE |
| N | 命令数据 | n | Uint8 | 命令数据 详细看下面每一帧的解释 |
| - | CRC校验 | 2 | Uint8 | 所有帧字节数的CRC-MODUBUS校验,高位在后(包头x2 + 长度x2 + 报文类型x1 + 应答标识x1 + 命令数据xN) |

**说明:**

- **报文类型**: 上位机发送的占用0x01 -- 0x0F, 从机占用所有,指令响应(当主机收到和自己相同的报文类型后,认为应答成功,否则继续等待回复,例如:上位机发送0x06 升级FPGA指令, 从机会回复0x10:显示当前状态,再回复0x06,表示响应当前指令完成)

- 报文类型作为从机数据的应答判断,上位机发的类型和收到的类型一致,即认为通信响应成功,否则进行通信超时判断

- 增加报文类型 0x10(总体结束), 当所选择的文件全部升级结束后,上位机下发系统结束命令, 等到下位机应答后上位机结束升级流程

- 修改通信超时判断:原来约定上位机发出指令到接收到响应报文的超时时间为10s 超过10s自动结束升级流程, 修改为持续10s未接收到任何报文,其实就是修改了接收到调试报文时也进行超时时间清零操作

## 下位机发送报文结构

| 字节序号 | 数据名称 | 字节数 | 数据类型 | 数据内容 |
|---------|---------|-------|---------|---------|
| 0 | 报头 | 1 | Uint8 | 固定为0x55 |
| 1 | 报头 | 1 | Uint8 | 固定为0xAA |
| 2 | ID | 1 | Uint8 | 当前通信口的标识 上位机不做处理 |
| 3 | 报文长度高位 | 1 | Uint8 | 报文总字节长度 |
| 4 | 报文长度低位 | 1 | Uint8 | |
| 5 | 报文类型 | 1 | Uint8 | **功能码及含义:**<br>0x01-0x10 - 回复上位机报文 (对应上位机报文类型)<br>0x1F - 调试信息显示报文 (从机回复专用,非响应报文,用来显示信息) |
| 6 | 应答标识 | 1 | Uint8 | **应答标识含义:**<br>0x00 - 表明命令执行成功 (不显示)<br>0x01 - 命令执行失败 (不显示)<br>0x02 - 数据校验错误 (显示)<br>0x03 - 接收超时 (显示)<br>0x04 - 允许升级 (不显示)<br>0x05 - 禁止升级 (显示)<br>0x06 - 退出升级流程 (显示)<br>0x07 - 解锁成功 (显示)<br>0x08 - 解锁失败 (显示)<br>0x09 - 准备擦除Flash (显示)<br>0x0A - 擦除Flash成功 (显示)<br>0x0B - 擦除Flash失败 (显示)<br>0x0C - 重启成功 (显示)<br>0x0D - 重启失败 (显示)<br>0x0E - 升级结束,所有数据包发送成功 (显示)<br>0x0F - 升级失败,数据大小出错 (显示)<br>0x10 - 升级失败,数据校验错误 (显示)<br>0x11 - FPGA配置文件自检通过 (显示)<br>0x12 - FPGA配置文件损坏 (显示)<br>0x13 - FPGA就绪,等待配置 (显示)<br>0x14 - FPGA状态异常 (显示)<br>0x15 - FPGA配置加载完成 (显示)<br>0x16 - FPGA配置成功 (显示)<br>0x17 - 启动应用程序 (显示)<br>0x18 - DSP版本号 (显示)<br>0x19 - Flash数据写入失败 (显示)<br>0x20 - FPGA配置失败 (显示)<br>0x21 - 写FPGA固件标志位失败 (显示)<br>0x22 - 数据包大小超限 (显示) |
| N | 命令数据 | n | Uint8 | 命令数据 详细看下面每一帧的解释 |
| - | CRC校验 | 2 | Uint8 | 所有帧字节数的CRC-MODUBUS校验,高位在后(包头x2 + IDx1 + 长度x2 + 报文类型x1 + 应答标识x1 + 命令数据xN) |

## 升级请求报文

### 升级请求报文

| 序号 | 描述 | 内容 |
|-----|------|------|
| 0 | 帧头 | 0xAA |
| 1 | 帧头 | 0x55 |
| 2 | 下位机ID | 按需填充 |
| 3 | 长度 | 0x00 |
| 4 | | 0x0A |
| 5 | 类型 | 0x01 |
| 6 | 应答标识 | 0xFE |
| 7 | 数据 | Bit0:FPGA升级标识 0:不升级 1:升级<br>Bit1: DSP1升级标识 0:不升级 1:升级<br>Bit2: DSP2升级标识 0:不升级 1:升级<br>Bit3: ARM升级标识 0:不升级 1:升级<br>其他:未使用,读数为0。 |
| 8-9 | CRC | |

### 升级请求响应报文

| 序号 | 描述 | 内容 |
|-----|------|------|
| 0 | 帧头 | 0x55 |
| 1 | 帧头 | 0xAA |
| 2 | ID | 下位机填充 |
| 3 | 长度 | 0x00 |
| 4 | | 0x0A |
| 5 | 类型 | 0x01 |
| 6 | 应答标识 | 如果都无异常 回复 0x04<br>任何一个有异常 回复 0x05 上位机显示"禁止升级" |
| 7 | 数据 | 0x00:当前升级过程正常 可以进行下一步操作<br>0x01:当前升级过程存在错误 弹窗"升级失败",退出升级流程 |
| 8-9 | CRC | |

## 系统复位报文

### 复位命令报文

| 序号 | 描述 | 内容 |
|-----|------|------|
| 0 | 帧头 | 0xAA |
| 1 | 帧头 | 0x55 |
| 2 | 下位机ID | 按需填充 |
| 3 | 长度 | 0x00 |
| 4 | | 0x0A |
| 5 | 类型 | 0x02 |
| 6 | 应答标识 | 0xFE |
| 7 | 数据 | 0x00 |
| 8-9 | CRC | |

### 复位响应报文

| 序号 | 描述 | 内容 |
|-----|------|------|
| 0 | 帧头 | 0x55 |
| 1 | 帧头 | 0xAA |
| 2 | ID | 下位机填充 |
| 3 | 长度 | 0x00 |
| 4 | | 0x0A |
| 5 | 类型 | 0x02 |
| 6 | 应答标识 | 0x0C 或 0x0D 发送重启结果 |
| 7 | 数据 | 0x00:当前升级过程正常 可以进行下一步操作<br>0x01:当前升级过程存在错误 弹窗"升级失败",退出升级流程 |
| 8-9 | CRC | |

## 调试报文

调试报文由下位机主动发起,不作为上位机的应答,用来显示当前状态信息,调试报文贯穿整个升级过程。

| 序号 | 描述 | 内容 |
|-----|------|------|
| 0 | 帧头 | 0xAA |
| 1 | | 0x55 |
| 2 | 下位机ID | 下位机 |
| 3 | 长度 | 0x00 |
| 4 | | 0x0A |
| 5 | 类型 | 0x10 信息显示 |
| 6 | 应答标识 | 参阅应答标识 |
| 7 | 数据 | 0x00 |
| 8-9 | CRC16 | |

在收到调试报文后,上位机根据"应答标识"内容,显示对应的信息

## 升级指令报文

升级指令包含了升级目标、升级文件大小、数据包总数、校验和等信息。

### 升级指令报文

| 序号 | 描述 | 内容 |
|-----|------|------|
| 0 | 帧头 | 0xAA |
| 1 | | 0x55 |
| 2 | 下位机ID | 按需填充 |
| 3 | 长度 | 0x00 |
| 4 | | 0x11 |
| 5 | 类型 | 0x03/0x06/0x0A/0x0D,分别对应ARM、FPGA、DSP1和DSP2 |
| 6 | 应答标识 | 0xFE |
| 7~10 | 数据 | 升级文件大小,高字节在前, 单位:字节 |
| 11~12 | | 数据包总数,升级文件将分为多少包下发,高字节在前 |
| 13~14 | | 固件文件的CRC16,文件所有字节的CRC16校验和 |
| 15-16 | CRC16 | |

在收到升级指令后,DSP或ARM会做一些初始化的工作,如擦除Flash等,准备工作做完之后给下载工具发送响应报文。

### 升级指令响应报文

| 序号 | 描述 | 内容 |
|-----|------|------|
| 0 | 帧头 | 0x55 |
| 1 | | 0xAA |
| 2 | ID | 下位机填充 |
| 3 | 长度 | 0x00 |
| 4 | | 0x0A |
| 5 | 类型 | 0x03/0x06/0x0A/0x0D,分别对应ARM、FPGA、DSP1和DSP2 |
| 6 | 应答标识 | 0x0A或0x0B |
| 7 | 数据 | 0x00:当前升级过程正常 可以进行下一步操作<br>0x01:当前升级过程存在错误 弹窗"升级失败",退出升级流程 |
| 8-9 | CRC16 | |

## 升级数据包报文

升级数据包报文包含升级包序号、升级文件内容。

### 升级数据包报文

| 序号 | 描述 | 内容 |
|-----|------|------|
| 0 | 帧头 | 0xAA |
| 1 | | 0x55 |
| 2 | 下位机ID | 按需填充 |
| 3 | 长度 | 0x0B+n |
| 4 | | |
| 5 | 类型 | 0x04/0x07/0x0B/0x0E,分别对应ARM、FPGA、DSP1和DSP2 |
| 6 | 应答标识 | 0xFE |
| 7~8 | 数据 | 升级包序号,从1开始 |
| n | | 升级文件内容,低字节在前 |
| - | CRC16 | |

收到升级数据包后,下位机将数据写入Flash,之后给上位机发送响应报文。

### 升级数据包响应报文(FPGA/DSP)

| 序号 | 描述 | 内容 |
|-----|------|------|
| 0 | 帧头 | 0x55 |
| 1 | | 0xAA |
| 2 | ID | 下位机填充 |
| 3 | 长度 | 0x00 |
| 4 | | 0x0E |
| 5 | 类型 | 0x04/0x07/0x0B/0x0E,分别对应ARM、FPGA、DSP1和DSP2 |
| 6 | 应答标识 | 0x00 或 其他 |
| 7 | 数据 | 0x00:当前升级过程正常 可以进行下一步操作<br>0x01:当前升级过程存在错误 弹窗"升级失败",退出升级流程 |
| 8~9 | | 升级包序号,占2个字节,高字节在前 |
| 10~11 | | 已接收的帧个数,占2个字节,高字节在前 |
| 12-13 | CRC | |

## 升级结束报文

上位机发送所有的升级数据之后,如果没有发生异常情况,则立即给下位机发送升级结束报文。

### 升级结束报文

| 序号 | 描述 | 内容 |
|-----|------|------|
| 0 | 帧头 | 0xAA |
| 1 | | 0x55 |
| 2 | 下位机ID | 按需填充 |
| 3 | 长度 | 0x00 |
| 4 | | 0x0A |
| 5 | 类型 | 0x05/0x08/0x0B/0x0F,分别对应ARM、FPGA、DSP1和DSP2 |
| 6 | 应答标识 | 0xFE |
| 7 | 数据 | 0x00 |
| 8-9 | CRC16 | |

在收到升级指令后,DSP或ARM会校验指令报文的字节数,包个数,校验位和实际收到的结果是否一致

### 升级结束响应报文

| 序号 | 描述 | 内容 |
|-----|------|------|
| 0 | 帧头 | 0x55 |
| 1 | | 0xAA |
| 2 | ID | 下位机填充 |
| 3 | 长度 | 0x00 |
| 4 | | 0x0A |
| 5 | 类型 | 0x05/0x08/0x0B/0x0F,分别对应ARM、FPGA、DSP1和DSP2 |
| 6 | 应答标识 | 参阅应答标识 |
| 7 | 数据 | 0x00:当前升级过程正常 可以进行下一步操作<br>0x01:当前升级过程存在错误 弹窗"升级失败",退出升级流程 |
| 8-9 | CRC16 | |

## 升级流程说明

当多个目标同时升级时,按 **FPGA-DSP1-DSP2-ARM** 顺序分别进行升级,请求升级命令和复位命令只下发一次,后续按 **升级命令 -- 升级数据 -- 升级结束** 循环进行每个设备的升级过程

# BootLoader升级流程详细描述

## 流程概述

本文档详细描述BootLoader固件升级的完整流程，包括每个步骤的报文格式、判断逻辑和错误处理机制。

## 初始状态

上位机处于初始状态，显示升级界面，等待用户操作。

---

## 升级流程步骤

### 步骤1: 点击"升级"按钮

**操作**: 用户在上位机界面点击"升级"按钮，启动升级流程。

**说明**:
- 上位机开始准备升级数据
- 初始化通信超时计时器
- 进入升级请求阶段

---

### 步骤2: 下发升级请求报文

**发送报文格式**: `AA 55 XX 00 0A 01 FE XX CRCH CRCL`

**报文字段说明**:
- `AA 55`: 帧头(固定)
- `XX`: 下位机ID(根据实际设备填充)
- `00 0A`: 报文长度(10字节)
- `01`: 报文类型(升级请求)
- `FE`: 应答标识
- `XX`: 数据字节，包含升级标识位
  - Bit0: FPGA升级标识(0=不升级, 1=升级)
  - Bit1: DSP1升级标识(0=不升级, 1=升级)
  - Bit2: DSP2升级标识(0=不升级, 1=升级)
  - Bit3: ARM升级标识(0=不升级, 1=升级)
- `CRCH CRCL`: CRC16校验(高字节在前)

**目的**: 向下位机发送升级请求，询问是否允许升级

**超时机制**:
- 通信超时时间: 10秒
- 超时处理: 上位机超过10s收不到下位机的响应后自动重发
- 重发次数: 累计重发3次
- 最终失败: 3次重发仍然无通信则退出升级流程并提示"通信超时,目标无响应,请检查设备状态"

---

### 步骤3: 等待升级请求回复

**接收报文格式**: `55 AA XX 00 0A 01 YY ZZ CRCH CRCL`

**判断逻辑**:
- 检查报文类型(byte5)是否为`0x01`(与发送报文类型一致)
- 检查应答标识(byte6):
  - `0x04`: 允许升级
  - `0x05`: 禁止升级
- 检查数据字节(byte7):
  - `0x00`: 当前升级过程正常，可以进行下一步操作
  - `0x01`: 当前升级过程存在错误

**分支处理**:
- **Y (允许升级，byte6=0x04 且 byte7=0x00)**:
  - 显示信息: ">>> 准备升级FPGA 20xx/xx/xx xx:xx:xx <<<"
  - 进入步骤4
- **N (禁止升级，byte6=0x05 或 byte7=0x01)**:
  - 显示错误信息: "禁止升级"
  - 返回初始状态，结束流程

**重要提示**:
任何一个节点的超时，都会弹窗提示"通信超时,目标无响应,请检查设备状态"并返回到初始状态。

---

### 步骤4: 下发重启报文

**发送报文格式**: `AA 55 XX 00 0A 02 FE 00 CRCH CRCL`

**报文字段说明**:
- `AA 55`: 帧头(固定)
- `XX`: 下位机ID
- `00 0A`: 报文长度(10字节)
- `02`: 报文类型(系统复位命令)
- `FE`: 应答标识
- `00`: 数据字节
- `CRCH CRCL`: CRC16校验

**目的**: 发送系统复位命令，使下位机重启进入BootLoader模式

---

### 步骤5: 等待重启回复

**接收报文格式**: `55 AA XX 00 0A 02 YY ZZ CRCH CRCL`

**判断逻辑**:
- 检查报文类型(byte5)是否为`0x02`
- 检查应答标识(byte6):
  - `0x0C`: 重启成功
  - `0x0D`: 重启失败
- 检查数据字节(byte7):
  - `0x00`: 当前升级过程正常
  - `0x01`: 当前升级过程存在错误

**分支处理**:
- **Y (重启成功，byte6=0x0C 且 byte7=0x00)**:
  - 显示信息: "重启成功"
  - 进入步骤6
- **N (重启失败)**:
  - 显示错误信息: "重启失败"
  - 返回初始状态，结束流程

---

### 步骤6: 下发升级指令报文

**发送报文格式**: `AA 55 XX 00 11 TT FE [FILE_SIZE] [PKT_NUM] [CRC16] CRCH CRCL`

**报文字段说明**:
- `AA 55`: 帧头(固定)
- `XX`: 下位机ID
- `00 11`: 报文长度(17字节)
- `TT`: 报文类型
  - `0x03`: ARM升级指令
  - `0x06`: FPGA升级指令
  - `0x0A`: DSP1升级指令
  - `0x0D`: DSP2升级指令
- `FE`: 应答标识
- `[FILE_SIZE]`: 升级文件大小(4字节，高字节在前)
- `[PKT_NUM]`: 数据包总数(2字节，高字节在前)
- `[CRC16]`: 固件文件的CRC16校验和(2字节)
- `CRCH CRCL`: 报文CRC16校验

**目的**: 告知下位机即将开始传输升级数据的基本信息

**数据说明**:
- 文件大小: 以字节为单位的固件文件总大小
- 数据包总数: 固件文件将被分割成多少个数据包传输
- 文件CRC16: 用于最终校验整个固件文件的完整性

---

### 步骤7: 等待升级指令回复

**接收报文格式**: `55 AA XX 00 0A TT YY ZZ CRCH CRCL`

**判断逻辑**:
- 检查报文类型(byte5)是否与发送的报文类型一致
- 检查应答标识(byte6):
  - `0x0A`: 擦除Flash成功(准备接收数据)
  - `0x0B`: 擦除Flash失败
- 检查数据字节(byte7):
  - `0x00`: 当前升级过程正常
  - `0x01`: 当前升级过程存在错误

**分支处理**:
- **Y (指令接受成功，byte6=0x0A 且 byte7=0x00)**:
  - 显示信息: "擦除Flash成功"
  - 初始化数据包计数器(从1开始)
  - 进入步骤8，开始数据传输
- **N (指令失败)**:
  - 显示错误信息: "擦除Flash失败"
  - 返回初始状态，结束流程

---

### 步骤8: 下发数据报文

**发送报文格式**: `AA 55 XX LL LL TT FE [PKT_NO] [DATA...] CRCH CRCL`

**报文字段说明**:
- `AA 55`: 帧头(固定)
- `XX`: 下位机ID
- `LL LL`: 报文长度(高字节在前，长度 = 数据长度 + 11)
- `TT`: 报文类型
  - `0x04`: ARM数据报文
  - `0x07`: FPGA数据报文
  - `0x0B`: DSP1数据报文
  - `0x0E`: DSP2数据报文
- `FE`: 应答标识
- `[PKT_NO]`: 数据包序号(2字节，高字节在前，从1开始)
- `[DATA...]`: 升级文件数据内容(n字节，根据每包数据大小而定)
- `CRCH CRCL`: 报文CRC16校验

**目的**: 发送实际的固件数据内容

**数据包说明**:
- 每个数据包包含固件文件的一部分数据
- 数据包按序号顺序发送，从1开始递增
- 每个数据包的大小可以根据实际情况设定(通常为256字节、512字节或1024字节)
- 数据以低字节在前的方式组织

---

### 步骤9: 等待数据报文回复

**接收报文格式**: `55 AA XX 00 0E TT YY ZZ [PKT_NO] [RCV_CNT] CRCH CRCL`

**判断逻辑**:
- 检查报文类型(byte5)是否与发送的报文类型一致
- 检查应答标识(byte6):
  - `0x00`: 数据接收成功
  - 其他: 数据接收失败(参考应答标识表)
- 检查数据字节(byte7):
  - `0x00`: 当前升级过程正常
  - `0x01`: 当前升级过程存在错误
- 检查升级包序号(byte8-9): 确认下位机收到的是哪个包
- 检查已接收帧个数(byte10-11): 确认下位机已接收的总包数

**分支处理**:
- **Y (数据接收成功，byte6=0x00 且 byte7=0x00)**:
  - 数据包计数器加1
  - 判断是否还有更多数据包需要发送:
    - **如果还有数据包**: 返回步骤8，继续发送下一包数据
    - **如果所有数据包已发送完成**: 进入步骤10
- **N (数据接收失败)**:
  - 显示错误信息(根据应答标识byte6的值):
    - `0x02`: "数据校验错误"
    - `0x03`: "接收超时"
    - `0x19`: "Flash数据写入失败"
    - `0x22`: "数据包大小超限"
  - 返回初始状态，结束流程

**注意事项**:
- 数据传输过程中，每发送一包数据都需要等待下位机确认
- 确认成功后才发送下一包数据，确保数据传输的可靠性
- 可以显示传输进度: (当前包号 / 总包数) × 100%

---

### 步骤10: 下发结束报文

**发送报文格式**: `AA 55 XX 00 0A TT FE 00 CRCH CRCL`

**报文字段说明**:
- `AA 55`: 帧头(固定)
- `XX`: 下位机ID
- `00 0A`: 报文长度(10字节)
- `TT`: 报文类型
  - `0x05`: ARM结束报文
  - `0x09`: FPGA结束报文
  - `0x0C`: DSP1结束报文
  - `0x0F`: DSP2结束报文
- `FE`: 应答标识
- `00`: 数据字节
- `CRCH CRCL`: 报文CRC16校验

**目的**: 通知下位机所有数据已传输完成，可以进行校验和后续处理

**说明**:
- 下位机收到结束报文后会进行数据完整性校验
- 校验内容包括: 总字节数、包个数、CRC16校验和

---

### 步骤11: 等待结束报文回复

**接收报文格式**: `55 AA XX 00 0A TT YY ZZ CRCH CRCL`

**判断逻辑**:
- 检查报文类型(byte5)是否与发送的报文类型一致
- 检查应答标识(byte6):
  - `0x0E`: 升级结束，所有数据包发送成功
  - `0x0F`: 升级失败，数据大小出错
  - `0x10`: 升级失败，数据校验错误
  - `0x16`: FPGA配置成功(仅FPGA)
  - `0x20`: FPGA配置失败(仅FPGA)
- 检查数据字节(byte7):
  - `0x00`: 当前升级过程正常
  - `0x01`: 当前升级过程存在错误

**分支处理**:
- **Y (升级成功，byte6=0x0E 或 0x16，且 byte7=0x00)**:
  - 显示成功信息: "升级结束，所有数据包发送成功"
  - 如果有多个设备需要升级:
    - 继续下一个设备的升级(返回步骤6)
  - 如果所有设备升级完成:
    - 发送总体结束报文(类型0x10)
    - 流程完成
- **N (升级失败)**:
  - 显示错误信息(根据应答标识byte6的值):
    - `0x0F`: "升级失败，数据大小出错"
    - `0x10`: "升级失败，数据校验错误"
    - `0x20`: "FPGA配置失败"
  - 返回初始状态，结束流程

---

## 关键说明

### 1. 报文格式规范

所有报文都遵循以下基本结构:
- **上位机发送**: `0xAA 0x55` 开头
- **下位机发送**: `0x55 0xAA` 开头
- 包含字段: 帧头、ID、长度、类型、应答标识、数据、CRC校验
- CRC校验: 使用CRC16-MODBUS算法，高字节在前

### 2. 超时处理机制

- **超时时间**: 每个等待回复的环节都有10秒超时时间
- **超时动作**:
  - 超时后自动重发当前报文
  - 累计重发3次
  - 3次后仍无响应则返回初始状态
- **提示信息**: "通信超时,目标无响应,请检查设备状态"

### 3. 错误处理原则

- 任何步骤收到失败响应(N)都应该返回初始状态
- 向用户显示相应的错误信息
- 记录错误日志，便于问题排查
- 提供友好的错误提示

### 4. 数据完整性保障

- **CRC16校验**:
  - 每个报文都有CRC16校验
  - 固件文件整体也有CRC16校验
- **数据包序号**: 便于追踪传输进度和检测丢包
- **确认应答**: 每包数据都需要确认应答
- **最终校验**: 结束报文阶段进行总体校验

### 5. 多设备升级顺序

如果需要升级多个设备，按照以下顺序进行:

1. **FPGA** (报文类型: 0x06, 0x07, 0x09)
2. **DSP1** (报文类型: 0x0A, 0x0B, 0x0C)
3. **DSP2** (报文类型: 0x0D, 0x0E, 0x0F)
4. **ARM** (报文类型: 0x03, 0x04, 0x05)

对每个设备重复步骤6-11。

**注意**:
- 升级请求报文(步骤2)只发送一次
- 系统复位报文(步骤4)只发送一次
- 每个设备独立执行: 升级指令 → 升级数据 → 升级结束

### 6. 调试报文

在整个升级过程中，下位机可能会主动发送调试报文(类型0x1F):
- 调试报文不作为上位机指令的应答
- 用于显示当前状态信息
- 上位机收到后应显示相应信息，但不影响升级流程
- 收到调试报文时也会重置超时计时器

### 7. 总体结束报文

所有设备升级完成后，上位机发送总体结束报文:
- **报文类型**: 0x10
- **目的**: 通知下位机整个升级流程结束
- **下位机响应**: 返回相同类型报文(0x10)
- **上位机收到响应后**: 结束升级流程，显示"升级完成"

---

## 流程图说明

完整的升级流程可以概括为:

```
初始状态 → 升级请求 → 系统复位 → 升级指令 → 数据传输(循环) → 升级结束 → 完成
```

每个阶段都有:
- 发送报文
- 等待应答
- 判断结果(Y/N)
- 相应处理

任何阶段失败或超时都会返回初始状态。

